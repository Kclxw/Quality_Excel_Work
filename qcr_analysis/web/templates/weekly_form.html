{% extends "base.html" %}
{% block content %}
<div class="form-container">
    <h1>ğŸ“Š Weekly Report</h1>
    <form id="weeklyForm" enctype="multipart/form-data">
        <div class="form-group">
            <label>æ•°æ®æ–‡ä»¶:</label>
            <input type="file" name="data_file" accept=".xlsx" required>
        </div>
        <div class="form-group">
            <label>MTMæ–‡ä»¶:</label>
            <input type="file" name="mtm_file" accept=".xlsx" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>å¼€å§‹æ—¥æœŸ:</label>
                <input type="date" name="start_date" value="2024-04-09">
            </div>
            <div class="form-group">
                <label>ç»“æŸæ—¥æœŸ:</label>
                <input type="date" name="end_date" value="2025-11-23">
            </div>
        </div>
        <div class="form-group">
            <label>æ‰¹æ¬¡åç§°:</label>
            <input type="text" name="batch_name" value="2024-2025">
        </div>
        <div class="form-group">
            <label>è¾“å‡ºç›®å½•ï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰:</label>
            <input type="text" name="output_dir" placeholder="ä¾‹å¦‚ï¼šD:\QCR\è¾“å‡º">
        </div>
        <div class="form-group">
            <label>PPTæ¨¡æ¿è·¯å¾„ï¼ˆå¯é€‰ï¼‰:</label>
            <input type="text" name="ppt_template" placeholder="ä¾‹å¦‚ï¼šD:\QCR\æ¨¡æ¿.pptx">
        </div>
        <div class="form-group">
            <label><input type="checkbox" name="generate_ppt" value="true" checked> ç”ŸæˆPPT</label>
            <label><input type="checkbox" name="use_llm" value="true"> å¯ç”¨AIåˆ†æ</label>
            <label><input type="checkbox" name="filter_unmapped" value="true" checked> è¿‡æ»¤æœªæ˜ å°„</label>
        </div>
        <details>
            <summary>é«˜çº§é€‰é¡¹ï¼ˆLLMé…ç½®ï¼‰</summary>
            <div class="form-row">
                <div class="form-group">
                    <label>LLMè¶…æ—¶(ç§’):</label>
                    <input type="number" name="llm_timeout" value="60">
                </div>
                <div class="form-group">
                    <label>LLM Top N:</label>
                    <input type="number" name="llm_top_n" value="3">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>è¦†ç›–åº¦é˜ˆå€¼(%):</label>
                    <input type="number" name="llm_coverage" value="80" step="0.1">
                </div>
                <div class="form-group">
                    <label>é‡ç‚¹æ‹¦æˆªé˜ˆå€¼(%):</label>
                    <input type="number" name="llm_focus" value="10" step="0.1">
                </div>
            </div>
        </details>
        <button type="submit" class="btn btn-primary">å¼€å§‹åˆ†æ</button>
        <a href="/" class="btn btn-secondary">è¿”å›</a>
    </form>
    <div id="result" style="display:none;"></div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.getElementById('weeklyForm').onsubmit = async function(e) {
    e.preventDefault();
    document.getElementById('result').innerHTML = '<p>åˆ†æä¸­...</p>';
    document.getElementById('result').style.display = 'block';
    
    const formData = new FormData(this);
    const response = await fetch('/api/analyze/weekly', {method: 'POST', body: formData});
    const data = await response.json();
    
    if (data.success) {
        let html = '<h3>âœ… æˆåŠŸ</h3><ul>';
        html += `<li>æ€»è®°å½•æ•°: ${data.total_records}</li>`;
        html += `<li>7å¤©æ— ç†ç”±: ${data.records_7d} æ¡</li>`;
        html += `<li>é7å¤©æ— ç†ç”±: ${data.records_non_7d} æ¡</li>`;
        html += `<li>è¾“å‡ºç›®å½•: <code>${data.output_dir}</code></li>`;
        html += '</ul>';
        if (data.ppt_download_url) {
            html += `<p><a href="${data.ppt_download_url}" class="btn btn-success">ğŸ“¥ ä¸‹è½½PPTæŠ¥å‘Š</a></p>`;
        } else if (data.ppt_path) {
            html += `<p class="text-warning">âš ï¸ ä½¿ç”¨è‡ªå®šä¹‰è¾“å‡ºç›®å½•ï¼Œè¯·é€šè¿‡"æ‰“å¼€è¾“å‡ºç›®å½•"æŸ¥çœ‹PPT</p>`;
        }
        html += `<p><button onclick="window.open('file:///${data.output_dir.replace(/\\\\/g, '/')}')" class="btn btn-info">ğŸ“‚ æ‰“å¼€è¾“å‡ºç›®å½•</button></p>`;
        document.getElementById('result').innerHTML = html;
    } else {
        document.getElementById('result').innerHTML = `<h3>âŒ å¤±è´¥</h3><p>${data.error}</p>`;
    }
};
</script>
{% endblock %}

