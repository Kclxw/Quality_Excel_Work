{% extends "base.html" %}
{% block content %}
<div class="form-container">
    <h1>ğŸ”¥ Top Issue</h1>
    <form id="topIssueForm" enctype="multipart/form-data">
        <div class="form-group">
            <label>æ•°æ®æ–‡ä»¶:</label>
            <input type="file" name="data_file" accept=".xlsx" required>
        </div>
        <div class="form-group">
            <label>MTMæ–‡ä»¶:</label>
            <input type="file" name="mtm_file" accept=".xlsx" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>å¼€å§‹æ—¥æœŸ:</label>
                <input type="date" name="start_date" value="2024-04-09">
            </div>
            <div class="form-group">
                <label>ç»“æŸæ—¥æœŸ:</label>
                <input type="date" name="end_date" value="2025-11-23">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>æ‰¹æ¬¡åç§°:</label>
                <input type="text" name="batch_name" value="2024-2025">
            </div>
            <div class="form-group">
                <label>Top N:</label>
                <input type="number" name="top_n" value="10" min="5" max="50">
            </div>
        </div>
        <div class="form-group">
            <label>è¾“å‡ºç›®å½•ï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰:</label>
            <input type="text" name="output_dir" placeholder="ä¾‹å¦‚ï¼šD:\QCR\è¾“å‡º">
        </div>
        <div class="form-group">
            <label>PPTæ¨¡æ¿è·¯å¾„ï¼ˆå¯é€‰ï¼‰:</label>
            <input type="text" name="ppt_template" placeholder="ä¾‹å¦‚ï¼šD:\QCR\æ¨¡æ¿.pptx">
        </div>
        <div class="form-group">
            <label><input type="checkbox" name="generate_ppt" value="true" checked> ç”ŸæˆPPT</label>
            <label><input type="checkbox" name="filter_unmapped" value="true" checked> è¿‡æ»¤æœªæ˜ å°„</label>
            <label><input type="checkbox" name="use_llm" value="true" checked> å¯ç”¨AIåˆ†æ</label>
        </div>
        <div class="advanced-options">
            <button type="button" class="collapsible">âš™ï¸ é«˜çº§é€‰é¡¹</button>
            <div class="content" style="display:none;">
                <div class="form-group">
                    <label>LLMè¶…æ—¶(ç§’):</label>
                    <input type="number" name="llm_timeout" value="60" min="30" max="300">
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-warning">å¼€å§‹åˆ†æ</button>
        <a href="/" class="btn btn-secondary">è¿”å›</a>
    </form>
    <div id="result" style="display:none;"></div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.getElementById('topIssueForm').onsubmit = async function(e) {
    e.preventDefault();
    document.getElementById('result').innerHTML = '<p>åˆ†æä¸­...</p>';
    document.getElementById('result').style.display = 'block';
    
    const response = await fetch('/api/analyze/top_issue', {method: 'POST', body: new FormData(this)});
    const data = await response.json();
    
    if (data.success) {
        let html = '<h3>âœ… æˆåŠŸ</h3><ul>';
        html += `<li>æ€»è®°å½•æ•°: ${data.total_records}</li>`;
        html += `<li>Top ${data.top_n} Issue å·²åˆ†æ</li>`;
        html += `<li>è¾“å‡ºç›®å½•: <code>${data.output_dir}</code></li>`;
        html += '</ul>';
        if (data.ppt_download_url) {
            html += `<p><a href="${data.ppt_download_url}" class="btn btn-success">ğŸ“¥ ä¸‹è½½PPTæŠ¥å‘Š</a></p>`;
        } else if (data.ppt_path) {
            html += `<p class="text-warning">âš ï¸ ä½¿ç”¨è‡ªå®šä¹‰è¾“å‡ºç›®å½•ï¼Œè¯·é€šè¿‡"æ‰“å¼€è¾“å‡ºç›®å½•"æŸ¥çœ‹PPT</p>`;
        }
        html += `<p><button onclick="window.open('file:///${data.output_dir.replace(/\\\\/g, '/')}')" class="btn btn-info">ğŸ“‚ æ‰“å¼€è¾“å‡ºç›®å½•</button></p>`;
        document.getElementById('result').innerHTML = html;
    } else {
        document.getElementById('result').innerHTML = `<h3>âŒ å¤±è´¥</h3><p>${data.error}</p>`;
    }
};

// é«˜çº§é€‰é¡¹æŠ˜å 
document.querySelectorAll('.collapsible').forEach(btn => {
    btn.addEventListener('click', function() {
        this.classList.toggle('active');
        const content = this.nextElementSibling;
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
    });
});
</script>
{% endblock %}

